<!DOCTYPE html>
<!--
Hello there.
You're a bold one; hitting that inspect button.
(•_• )
( •_•)
( •_•)>⌐■-■
(⌐■_■)
Welcome to my hand-crafted fair-trade small-batch artisanal DOM.
Designed in Seattle, forged in Puget Sound.
@UncheckedError
-->
<html>

<head>
    <title>Using Sep to Export a CSV in Razor Pages</title>
    <meta charset="UTF-8">
    <meta name="description" content="Sep is a zero-allocation library for
            parsing CSV files in .NET. Here's how I used it in my ASP.NET Core .NET 9 web app.">
    <meta name="keywords"
        content="Personal, Blog, Thomas, August, Ryan, Developer, GIS, Web, Seattle, Maps, UncheckedError">
    <meta name="author" content="Thomas August Ryan @UncheckedError">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Skip the favicon. -->
    <link
        href="data:image/x-icon;base64,AAABAAEAEBAAAAEACABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAACEAEUAAAAAAGIBTABJSUkAw7ItAF7o5QAhlg8AhE3ZALSIDwDj5WMAvq0rAJYGVQB6AEYAmFgLAASvTwCFAUMAtH4TAJRG7QAIl6wAVFRUADq3zAAP0NIAr0T6AAadrACUA04AKrE4ADd0sgBlCK4A4/M9ABHYvABuFN8A/v79AEBBSQBvAEgAMg/XAF3o5wAd3NoAXAtDAAefsAD+/v4AeiKfAIQASAAbKbkA19xOAJYGWABqAFIAiQJLAAAeqAAGsnMAZTPlAFYX4gAbcrMASrrOAFrr6QD29vUAlVMEAEfOtwAvlQ0A1Mw6ABdhoQB9BE8ABcO4AACdAQAAIJsAlCDXABNKuQD//P0A6enpAAgskgBQoB8ALrmAALJ+DwCAAEIAAEeRACu/ZwCExzwAWgB+ABl9AAA1NTUA5eXlAACLFABmCcAAkwJNAOX2KAAUNasAV684AFYBUwCNA0sA5+chAFsAXgBf5dsAVABvADSsvwAwI9UAJaoXAOXXJQD///8AI+zjAAGeKgACVpIAAEuQAFEAXwCQHMQACw3TAP39/QBIqwsAHi7IAGq2FAAvLy8AGqMsAAKPAgDQ0NAAbwWCAPv7+wCfWQcAoMY4AGYd5QCn3yMAiARKAKY+8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYGBgYGAnFSZjcGBgYGBgYGBgYGAdPRUXY0RwZ2BgYGBgYGBNDh0kEmQ/ZzIeYGBgYCdNPlAwYSZJLyIeUUxgYGB1aU1uYmEmYy90G0xlTmAnHHVrOTliJmMvG1tWLSVgX19YU1NTAQEBAQMBDAApbxAQRwgQEAFgYAF2dlcYLHYNDTdyDQ0BYGABdnZ2Ugt2CgoEOjpGAQEBAUhISA8udmAJK3NzRgU0GkFmcAIhPB9gK0tFBkYFNBpBB2ZwWWxgYDZVXm1GBTQaKjF3QChoYGBgXhlKODVcO1RdERYTYGBgYGBCOFojFDNBaiBxYGBgYGBgYGBDIxQzQU9gYGBgYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
        rel="icon" type="image/x-icon" />
    <!-- Tracking/telemetry code please disable if you're not into that sort of thing -->
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "jk0a2nru7l");
    </script>
    <style type="text/css">
        .center {
            /* Off white to reduce eye strain. */
            background: #FDFDFD;
            border-radius: 2px;
            padding: 5%;
            margin: 3% 0% 3% 0%;
            /* Shamelessly stolen from: https://codepen.io/sdthornton/pen/wBZdXq */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            transition: all 0.3s cubic-bezier(.25, .8, .25, 1);
        }

        body {
            /* Compatible with everything, and anything. */
            font-family: sans-serif;
            /* Off white to reduce eye strain. */
            background-color: #DCDCDC;
            margin: auto;
            padding: 0% 3% 0% 3%;
            max-width: 800px;
            /* Off black to reduce eye strain. */
            color: #2A2A2A;
        }

        h1,
        h1.a {
            letter-spacing: 0.03em;
            font-size: 4.5em;
            word-spacing: 5em;
            line-height: 1.1em;
            margin: 0%;
            font-weight: 100;
        }

        h3 {
            letter-spacing: 0.01rem;
            font-size: 2.4rem;
            font-weight: 100;
            margin-top: 0;
        }

        li {
            font-size: 1.3rem;
            line-height: 2rem;
        }

        p {
            font-size: 1.3rem;
            line-height: 2rem;
        }

        body>article>p>a {
            text-decoration: none;
            border-bottom: 1px solid #2A2A2A;
        }

        a:link,
        a:visited {
            color: #2A2A2A;
        }

        a:hover,
        a:active {
            color: grey;
        }

        .underline {
            text-decoration: none;
        }

        blockquote {
            background: #f5f5f5;
            border-radius: 2px;
            padding: 1rem;
            margin: 0% 0% 0% 0%;
        }

        .links {
            display: flex;
            flex-flow: column wrap;
            align-items: flex-end;
            justify-content: space-between;
        }

        h1>a:link,
        h1>a:visited {
            color: grey;
        }

        h1>a:hover,
        h1>a:active {
            color: #d2d2d2;
        }

        .top {
            display: flex;
            justify-content: space-between;
        }

        img {
            width: 100%;
        }

        @media (max-width: 680px) {
            .hidemobile {
                display: none;
            }

            /* Flex makes this look wonky on small screens */
            .top {
                display: block;
            }
        }

        /*https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme*/
        @media (prefers-color-scheme: dark) {
            .center {
                /* Off white to reduce eye strain. */
                background: #242424;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            }

            body {
                /* Off black to reduce eye strain. */
                background-color: #171717;
                /* Off white to reduce eye strain. */
                color: #e3e3e3;
            }

            blockquote {
                background: #2e2e2e;
            }

            body>article>p>a {
                text-decoration: none;
                border-bottom: 1px solid #4db2ff;
            }

            a:link,
            a:visited {
                color: #e3e3e3;
            }

            a:hover,
            a:active {
                color: #0091ff;
            }

            h1>a:link,
            h1>a:visited {
                color: #6b6b6b;
            }

            h1>a:hover,
            h1>a:active {
                color: #0091ff;
            }
        }
    </style>
</head>

<body>
    <header class="center top">
        <a href="./../../index.html" class="underline">
            <h1>Thomas<br>August<br>Ryan</h1>
        </a>
        <h1 class="links hidemobile">
            <a href="./../../work.html" class="underline">Work</a>
            <a href="./../../posts.html" class="underline">Posts</a>
            <a href="./../../resume.pdf" class="underline">Résumé</a>
        </h1>
    </header>
    <article class="center">
        <time datetime="2025-12-02">
            <strong>November 2nd, 2025</strong>
        </time>
        <h3>Using Sep to Export a CSV in Razor Pages</h3>
        <p>After years of using <a href="https://github.com/JoshClose/CsvHelper" target="_blank">CSVHelper</a> I learned about <a href="https://github.com/nietras/Sep/"
                target="_blank">Sep</a> earlier this year. Sep is a zero-allocation library
            for
            parsing CSV files in .NET. Not allocating additional memory for parsing is wonderful, especially when merely
            reading a CSV file can consume hundreds of MBs of memory.
        </p>
        <p>For the web apps I write, my goal is to take a CSV
            file stored locally and then convert it into an array of objects in C#. That array will then get wrapped in
            a FrozenDictionary and passed around the app as singleton so I can perform lookups on it using a foreign
            key. The CSV starts its life as an export from another app that I want my app to link back to.
        </p>
        <p>Serializing a CSV to an array of objects using Sep is straightforward. We start by creating a reader object,
            passing it a file path as a parameter, and then looping over rows to construct each object from the desired
            columns in the CSV. Getting the value of a column for the specific row is as simple as passing the row
            object the name of the column, like you would with a dictionary and then calling .ToString(). This makes it
            easy to process or format that value before building your object out of it. </p>
        <script src="https://gist.github.com/uncheckederror/36cd19a434158e0098de888843895e7d.js"></script>
        <p>Sep also has support for <a href="https://nietras.com/2024/05/05/sep-0-4-0-0-5-2/" target="_blank"
                rel="noopener noreferrer">ParallelEnumeration</a> so that you can process the rows in your CSV in
            parallel, which
            reduces the amount of time it takes to get your array of objects together.</p>
        <h3>Using Sep for Exporting Data</h3>
        <p>Recently I built a status page in my app so that I could verify that it had all the data that it needed to
            work correctly. After showing this page to the team, they asked for an export to CSV button so they could
            play with the data in Excel. I turned to Sep as the perfect tool to implement this. But I hadn’t used Sep
            for writing CSVs before. Working through the readme.md on Github left me more confused. I decided to hunt
            for
            practical examples to reference as I wrote my own implementation. </p>
        <p>Credit where credit was due, the example I needed was in the readme and in the section labeled 'example' but
            I’m going to expand on it here because I didn’t understand after reading it the first few times. If we start
            with an array of objects in C# we need to loop over them to construct our CSV row by row. That’s easy enough
            with a foreach loop, but we’ll also need to create a writer object using Sep to submit our rows to. </p>
        <p>In the Sep readme they show creating a writer from an existing reader. But my status page doesn’t expect CSVs
            as input, so I don’t have a reader object to start from. To work around this, we can create our own writer
            object by calling the Sep library, passing it the delimiter we want to use (in this case the char ‘,’), and
            then calling for a writer object that produces text, rather than a file.</p>
        <script src="https://gist.github.com/uncheckederror/31d5fbcb0cd0128f81dda0f84a62bb6f.js"></script>
        <h3>Dealing with Dirty Data</h3>
        <p>When testing the CSV I realized that one of the columns had strings with commas in them, this broke the CSV
            output by formatting some rows with additional columns. Sep supports <a
                href="https://nietras.com/2025/01/12/sep-0-7-0/" target="_blank" rel="noopener noreferrer">escaping
                columns</a> using double quotes
            but doing so requires using the SepWriterOptions struct which was a bit awkward at first. </p>
        <p>In other libraries you can modify the properties of your reader and writer objects by doting into them and
            then setting a new value, but that doesn’t work with Sep because the reader and writer objects are not
            simple classes. They are readonly record structs which prevents us from updating them after they’ve
            been created. We can use the ‘with’ operator in C# to create a copy of this struct with updated fields and
            replace the existing SepWriterOptions struct. This pattern isn’t explicitly in the readme.md but is clearly
            described in a supplemental blog post by Sep’s author on <a href="https://nietras.com/2025/01/12/sep-0-7-0/"
                target="_blank" rel="noopener noreferrer">CSV Escape Support</a>.</p>
        <script src="https://gist.github.com/uncheckederror/83a7a63de533819ddb17aa487a28f097.js"></script>
        <h3>Wrapping it up for Razor Pages</h3>
        <p>Now that I’ve written about reading and writing CSV with Sep here’s how I integrated this work with my .NET
            10, ASP.NET Core Razor pages web app. I started by adding an OnPostAsCSV() route handler to the index.cs
            that is paired with my index.cshtml file in the Razor Pages project-style. The purpose of this route is to
            dump the data from the OnGet() route into a CSV. It takes no parameters and it returns a FileResult which is
            the CSV. </p>
        <script src="https://gist.github.com/uncheckederror/60459a65e37e2c1ed72302d8b462c2b4.js"></script>
        <p>Back on the .cshtml page all we have to do is add an export button that calls the AsCSV route and is wrapped
            in a form set to POST.</p>
        <script src="https://gist.github.com/uncheckederror/332d01e463ea5aeb4a045b9dea0ab0b7.js"></script>
        <p>There you have it, an Export to CSV button for a Razer Pages web app built using the Sep library. Enjoy!</p>
    </article>
    <article class="center">
        <time datetime="2026-01-04">
            <h2>January 4th, 2026</h2>
        </time>
        <h3>UPDATE 1</h3>
        <p>The author of the Sep library stumbled upon <a href="https://github.com/nietras/Sep/pull/448" target="_blank">this post</a> and offered some helpful tips to improve this method by taking advantage of Sep’s support for Streams to skip the creation of a string when calling Sep.Writer.ToText(). Additionally, we can write directly to the UTF-8 format by wrapping our Stream in a StreamWriter (which defaults to writing in the UTF-8 format), rather than converting the string using Encoding.UTF8.GetBytes(writer.ToString()) at the end.</p>
        <p>We can implement this by creating a MemoryStream() and then a StreamWriter() that takes that our mStream as a parameter before constructing the Sep.Writer and then calling .To(utf8Wrtier) rather than .ToText(). When returning the FileResult at the end rather than using Encoding.UTF8.GetBytes(writer.ToString()) we can simply call mStream.GetBuffer() to hand back the UTF-8 encoded byte[] that File() expects as mStream now contains all the bytes we wrote into the writer object as we set the rows.</p>
        <script src="https://gist.github.com/uncheckederror/2ac932aeaca1f2a2af9791ff09448066.js"></script>
        <p>Now we’ve skipped allocating a string containing the contents of the CSV and the cost of converting that string to the UTF-8 format. Yay!</p>
        <p>I'd like to thank <a href="https://github.com/nietras" target="_blank">nietras</a> for creating and maintaining Sep and their blogs (<a href="https://nietras.com/" target="_blank">as linked above</a>) are a fun read.</p>
    </article>
    <footer class="center top">
        <a href="./../../index.html" class="underline hidemobile">
            <h1>Thomas<br>August<br>Ryan</h1>
        </a>
        <h1 class="links">
            <a href="./../../work.html" class="underline">Work</a>
            <a href="./../../posts.html" class="underline">Posts</a>
            <a href="./../../resume.pdf" class="underline">Résumé</a>
        </h1>
    </footer>
</body>

</html>