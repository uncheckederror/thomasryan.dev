<!DOCTYPE html>
<!--
Hello there.
You're a bold one; hitting that inspect button.
(•_• )
( •_•)
( •_•)>⌐■-■
(⌐■_■)
Welcome to my hand-crafted fair-trade small-batch artisanal DOM.
Designed in Seattle, forged in Puget Sound.
@UncheckedError
-->
<html>

<head>
    <title>Cleaning up a .NET 6 Web API Converted from Visual Basic</title>
    <meta charset="UTF-8">
    <meta name="description"
        content="The Road Assets Editor or RAE is a tool that enables employees to review all road assets built in King County.">
    <meta name="keywords"
        content="Personal, Blog, Thomas, August, Ryan, Developer, GIS, Web, Seattle, Maps, UncheckedError">
    <meta name="author" content="Thomas August Ryan @UncheckedError">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Skip the favicon. -->
    <link
        href="data:image/x-icon;base64,AAABAAEAEBAAAAEACABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAACEAEUAAAAAAGIBTABJSUkAw7ItAF7o5QAhlg8AhE3ZALSIDwDj5WMAvq0rAJYGVQB6AEYAmFgLAASvTwCFAUMAtH4TAJRG7QAIl6wAVFRUADq3zAAP0NIAr0T6AAadrACUA04AKrE4ADd0sgBlCK4A4/M9ABHYvABuFN8A/v79AEBBSQBvAEgAMg/XAF3o5wAd3NoAXAtDAAefsAD+/v4AeiKfAIQASAAbKbkA19xOAJYGWABqAFIAiQJLAAAeqAAGsnMAZTPlAFYX4gAbcrMASrrOAFrr6QD29vUAlVMEAEfOtwAvlQ0A1Mw6ABdhoQB9BE8ABcO4AACdAQAAIJsAlCDXABNKuQD//P0A6enpAAgskgBQoB8ALrmAALJ+DwCAAEIAAEeRACu/ZwCExzwAWgB+ABl9AAA1NTUA5eXlAACLFABmCcAAkwJNAOX2KAAUNasAV684AFYBUwCNA0sA5+chAFsAXgBf5dsAVABvADSsvwAwI9UAJaoXAOXXJQD///8AI+zjAAGeKgACVpIAAEuQAFEAXwCQHMQACw3TAP39/QBIqwsAHi7IAGq2FAAvLy8AGqMsAAKPAgDQ0NAAbwWCAPv7+wCfWQcAoMY4AGYd5QCn3yMAiARKAKY+8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYGBgYGAnFSZjcGBgYGBgYGBgYGAdPRUXY0RwZ2BgYGBgYGBNDh0kEmQ/ZzIeYGBgYCdNPlAwYSZJLyIeUUxgYGB1aU1uYmEmYy90G0xlTmAnHHVrOTliJmMvG1tWLSVgX19YU1NTAQEBAQMBDAApbxAQRwgQEAFgYAF2dlcYLHYNDTdyDQ0BYGABdnZ2Ugt2CgoEOjpGAQEBAUhISA8udmAJK3NzRgU0GkFmcAIhPB9gK0tFBkYFNBpBB2ZwWWxgYDZVXm1GBTQaKjF3QChoYGBgXhlKODVcO1RdERYTYGBgYGBCOFojFDNBaiBxYGBgYGBgYGBDIxQzQU9gYGBgYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
        rel="icon" type="image/x-icon" />
    <!-- Tracking/telemetry code please disable if you're not into that sort of thing -->
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "jk0a2nru7l");
    </script>
    <style type="text/css">
        .center {
            /* Off white to reduce eye strain. */
            background: #FDFDFD;
            border-radius: 2px;
            padding: 5%;
            margin: 3% 0% 3% 0%;
            /* Shamelessly stolen from: https://codepen.io/sdthornton/pen/wBZdXq */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            transition: all 0.3s cubic-bezier(.25, .8, .25, 1);
        }

        body {
            /* Compatible with everything, and anything. */
            font-family: sans-serif;
            /* Off white to reduce eye strain. */
            background-color: #DCDCDC;
            margin: auto;
            padding: 0% 3% 0% 3%;
            max-width: 1200px;
            /* Off black to reduce eye strain. */
            color: #2A2A2A;
        }

        h1,
        h1.a {
            letter-spacing: 0.03em;
            font-size: 4.5em;
            word-spacing: 5em;
            line-height: 1.1em;
            margin: 0%;
            font-weight: 100;
        }

        h3 {
            letter-spacing: 0.01rem;
            font-size: 2.4rem;
            font-weight: 100;
        }

        li {
            font-size: 1.4rem;
            line-height: 2rem;
        }

        p {
            font-size: 1.4rem;
            line-height: 2rem;
        }

        body>article>p>a {
            text-decoration: none;
            border-bottom: 1px solid #2A2A2A;
        }

        a:link,
        a:visited {
            color: #2A2A2A;
        }

        a:hover,
        a:active {
            color: grey;
        }

        .underline {
            text-decoration: none;
        }

        blockquote {
            background: #f5f5f5;
            border-radius: 2px;
            padding: 1rem;
            margin: 0% 0% 0% 0%;
        }

        .links {
            display: flex;
            flex-flow: column wrap;
            align-items: flex-end;
            justify-content: space-between;
        }

        h1>a:link,
        h1>a:visited {
            color: grey;
        }

        h1>a:hover,
        h1>a:active {
            color: #d2d2d2;
        }

        .top {
            display: flex;
            justify-content: space-between;
        }

        img {
            width: 100%;
        }

        @media (max-width: 680px) {
            .hidemobile {
                display: none;
            }
        }

        /*https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme*/
        @media (prefers-color-scheme: dark) {
            .center {
                /* Off white to reduce eye strain. */
                background: #242424;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            }

            body {
                /* Off black to reduce eye strain. */
                background-color: #171717;
                /* Off white to reduce eye strain. */
                color: #e3e3e3;
            }

            blockquote {
                background: #2e2e2e;
            }

            body>article>p>a {
                text-decoration: none;
                border-bottom: 1px solid #4db2ff;
            }

            a:link,
            a:visited {
                color: #e3e3e3;
            }

            a:hover,
            a:active {
                color: #0091ff;
            }

            h1>a:link,
            h1>a:visited {
                color: #6b6b6b;
            }

            h1>a:hover,
            h1>a:active {
                color: #0091ff;
            }
        }
    </style>
</head>

<body>
    <header class="center top">
        <a href="./../../index.html" class="underline">
            <h1>Thomas<br>August<br>Ryan</h1>
        </a>
        <h1 class="links hidemobile">
            <a href="./../../work.html" class="underline">Work</a>
            <a href="./../../posts.html" class="underline">Posts</a>
            <a href="./../../resume.pdf" class="underline">Résumé</a>
        </h1>
    </header>
    <article class="center">
        <time datetime="2022-05-21">
            <h2>May 21th, 2022</h2>
        </time>
        <h3>Cleaning up a .NET 6 Web API Converted from Visual Basic</h3>
        <p>The Road Assets Editor or RAE is a tool that enables employees to review all road assets built in King
            County. It was created to support the road crews that are tasked with inventorying and reviewing the status
            of these assets on a periodic basis.</p>
        <p>A road asset is a service to the public and a responsibility of the
            county. They range from features like an ADA compliant ramp at the corner of an intersection to a speed bump
            or signage attached to a pole. Hundreds of thousands of assets are catalogued and maintained in the RoadsGIS
            database. Map queries against this data set are handled by ArcGIS Server which exposes feature services that
            can be queried using a REST API. For queries that don’t directly contain spatial data the RoadsGIS-Web-API
            was created.</p>
        <p>The initial version of this product was built as an interactive web map using ESRI’s ArcGIS JavaScript
            library and Microsoft’s Silverlight technology stack. The database resides in SQL Server 2017 and the app is
            hosted on Windows using Internet Information Services or IIS as the web server. The new version of the app
            uses the current iteration of ESRI’s ArcGIS JavaScript library nested inside of React components and backed
            by the Next.js framework. These technologies replace the existing Silverlight web app.
        </p>
        <h3>Convert Sync to Async</h3>
        <p>The spatial and non-spatial queries made by the Silverlight app are made directly by that app. This
            architecture was broken out into the model I described above where the frontend web app queries spatial
            data using ArcGIS Server REST API and non-spatial data using the RoadsGIS-Web-API. To get the project
            started, code from the Silverlight app was used either directly in, or as inspiration for the new API. This
            worked well and over a period of a few months the team was able to get the new API up and running.
            Shortly after, the team began development of the Next.js-based frontend which handles the web map and uses
            this new API to gather data to assist the editing process.</p>
        <p>Near the completion of the new frontend, we started to confront the variety of strategies used in this
            project to store are set configuration information. It was from this angle that I began a two-week
            refactoring of the RoadsGIS-Web-API project which resulted in 29 commits and a drastically simplified
            codebase. One of the big strengths of the .NET ecosystem is the pervasive use of asynchronous programming
            which enables improved scalability particularly in web apps. Unfortunately, the API project was completely
            synchronous.</p>
        <a href="synchronus endpoint.png" title="The completely synchronous implementation of this endpoint."><img
                src="synchronus endpoint.png" alt="The completely synchronous implementation of this endpoint."></a>
        <p>To solve this problem, I started by rewriting the code that used the <a
                href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/async" target="_blank"
                rel="noopener noreferrer">Entity Framework Core</a> library to make
            database calls. Connecting to a database, making a query, and then serializing the response to an object is
            a fundamentally asynchronous process as we don’t know when the database will respond to the request. Because
            of the virality of the async and await keywords in C# I then worked up the stack from these now async
            database calls to the controller where the endpoints were converted to async.</p>
        <a href="asynchronous endpoint.png" title="The asynchronous implementation of this endpoint."><img
                src="asynchronous endpoint.png" alt="The asynchronous implementation of this endpoint."></a>
        <p>Interestingly some of the API endpoints made call to the ArcGIS Server REST API before returning non-spatial
            data like an Id or Description to the frontend web app. HTTP calls are another fundamentally asynchronous
            process as we don’t know when the web server, we submitted the request to will respond. This code also used
            the depreciated System.Web library to make these API requests. To solve this issue, I used the <a
                href="https://flurl.dev/docs/fluent-http/" target="_blank" rel="noopener noreferrer">Flurl library</a>
            which is a comfortable and fully async wrapper around the newer System.Net.HTTP library.</p>
        <p>Now the remote resources consumed by the web API are done so asynchronously and the endpoints exposed by the
            API handle incoming requests asynchronously too. The upside to this is that the API can now handle many more
            requests as the threads that would have been consumed by waiting for remote resources to respond can now be
            suspended, while other requests are handled, and then resumed when they are ready.</p>

        <h3>Exceptions are not your Enemy</h3>
        <p>The usage of null objects and try catch statements is another area that was ripe for improvement in the web
            API. Often code in the API would start by creating a null instance of an object and then at the end, the
            object would be returned. Somewhere in the middle, inside of a try catch statement, the null object would
            hopefully be replaced by real data. But if an exception were to occur, that exception would be suppressed,
            and the method would return null for no clear reason to the caller. </p>
        <a href="bad try catch example.png" title="How not to use a try catch in C#."><img
                src="bad try catch example.png" alt="How not to use a try catch in C#."></a>
        <p>To solve this issue, we can remove the
            null object at the start of the method and the return of that object at the end. This creates a different
            issue as our method now lacks a return statement, but we can solve that by swapping in a return in place of
            assignments to the null object.</p>
        <a href="good try catach example.png" title="How to clean up the use of bad try catches."><img
                src="good try catach example.png" alt="How to clean up the use of bad try catches."></a>
        <p>Then there is the issue of using or misusing try catch statements to suppress exceptions. A good rule of
            thumb here is to ask yourself if this method should fail for any reason, if the answer is no, then do not
            wrap it in a try catch statement. This is advantageous because when your code does break, the exception will
            bubble up through the stack to where you’re calling the code and then you will see specifically where things
            broke
            when you are debugging the issue. Under the old style nothing would appear to be wrong, but your code
            wouldn’t work correctly.</p>
        <p>These two changes to the style of the code lead to a final product that is easier to read, does not return
            null under any circumstances, and is easier to troubleshoot and debug when it breaks.
        </p>
        <h3>Configured for Success</h3>
        <p>Configuration is another area where things were simplified. In an ASP.NET Core web app the primary source of
            truth for configuration is a file named appsettings.json. This is a JSON formatted file that contains
            key-value pairs that are read when the applications starts up. Inside of the app you can read the values of
            these keys as strings by asking the configuration object for a specific key.</p>
        <p>You can also add additional sources of information to a configuration
            object. To take advantage of this we add the environmental variables present on the system. The idea here is
            that if the target system needs the app configured in specific way, that wasn't handled in the deployment
            pipeline, you can set an environmental variable on
            the Azure app service instance to accomplish that task. We also removed a dependency on the RoadsGIS
            database which is where the configuration data was stored in prior versions of this app. Those items are now
            in the appsettings.json file.</p>
        <p>While directly converting code from a legacy Visual Basic project into a C# web API does work, there’s a lot
            to be gained from doing a second pass. Newer language features in C# can help you to make your code terser,
            more performant, and easier to reason about than a direct 1 to 1 conversion of Visual Basic concepts and
            style. If you can make time for a refactoring process like this, I highly recommend it.</p>
    </article>
    <footer class="center top">
        <a href="./../../index.html" class="underline hidemobile">
            <h1>Thomas<br>August<br>Ryan</h1>
        </a>
        <h1 class="links">
            <a href="./../../work.html" class="underline">Work</a>
            <a href="./../../posts.html" class="underline">Posts</a>
            <a href="./../../resume.pdf" class="underline">Résumé</a>
        </h1>
    </footer>
</body>

</html>