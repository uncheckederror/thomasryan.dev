<!DOCTYPE html>
<!--
Hello there.
You're a bold one; hitting that inspect button.
(•_• )
( •_•)
( •_•)>⌐■-■
(⌐■_■)
Welcome to my hand-crafted fair-trade small-batch artisanal DOM.
Designed in Seattle, forged in Puget Sound.
@UncheckedError
-->
<html>

<head>
    <title>Using Next.js and ArcGIS JS to build Geospatial Web Apps</title>
    <meta charset="UTF-8">
    <meta name="description"
        content="ArcGIS JS is a JavaScript library for creating web maps using ESRI’s ecosystem of tools and services.">
    <meta name="keywords"
        content="Personal, Blog, Thomas, August, Ryan, Developer, GIS, Web, Seattle, Maps, UncheckedError">
    <meta name="author" content="Thomas August Ryan @UncheckedError">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Skip the favicon. -->
    <link
        href="data:image/x-icon;base64,AAABAAEAEBAAAAEACABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAACEAEUAAAAAAGIBTABJSUkAw7ItAF7o5QAhlg8AhE3ZALSIDwDj5WMAvq0rAJYGVQB6AEYAmFgLAASvTwCFAUMAtH4TAJRG7QAIl6wAVFRUADq3zAAP0NIAr0T6AAadrACUA04AKrE4ADd0sgBlCK4A4/M9ABHYvABuFN8A/v79AEBBSQBvAEgAMg/XAF3o5wAd3NoAXAtDAAefsAD+/v4AeiKfAIQASAAbKbkA19xOAJYGWABqAFIAiQJLAAAeqAAGsnMAZTPlAFYX4gAbcrMASrrOAFrr6QD29vUAlVMEAEfOtwAvlQ0A1Mw6ABdhoQB9BE8ABcO4AACdAQAAIJsAlCDXABNKuQD//P0A6enpAAgskgBQoB8ALrmAALJ+DwCAAEIAAEeRACu/ZwCExzwAWgB+ABl9AAA1NTUA5eXlAACLFABmCcAAkwJNAOX2KAAUNasAV684AFYBUwCNA0sA5+chAFsAXgBf5dsAVABvADSsvwAwI9UAJaoXAOXXJQD///8AI+zjAAGeKgACVpIAAEuQAFEAXwCQHMQACw3TAP39/QBIqwsAHi7IAGq2FAAvLy8AGqMsAAKPAgDQ0NAAbwWCAPv7+wCfWQcAoMY4AGYd5QCn3yMAiARKAKY+8QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYGBgYGAnFSZjcGBgYGBgYGBgYGAdPRUXY0RwZ2BgYGBgYGBNDh0kEmQ/ZzIeYGBgYCdNPlAwYSZJLyIeUUxgYGB1aU1uYmEmYy90G0xlTmAnHHVrOTliJmMvG1tWLSVgX19YU1NTAQEBAQMBDAApbxAQRwgQEAFgYAF2dlcYLHYNDTdyDQ0BYGABdnZ2Ugt2CgoEOjpGAQEBAUhISA8udmAJK3NzRgU0GkFmcAIhPB9gK0tFBkYFNBpBB2ZwWWxgYDZVXm1GBTQaKjF3QChoYGBgXhlKODVcO1RdERYTYGBgYGBCOFojFDNBaiBxYGBgYGBgYGBDIxQzQU9gYGBgYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
        rel="icon" type="image/x-icon" />
    <!-- Tracking/telemetry code please disable if you're not into that sort of thing -->
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "jk0a2nru7l");
    </script>
    <style type="text/css">
        .center {
            /* Off white to reduce eye strain. */
            background: #FDFDFD;
            border-radius: 2px;
            padding: 5%;
            margin: 3% 0% 3% 0%;
            /* Shamelessly stolen from: https://codepen.io/sdthornton/pen/wBZdXq */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            transition: all 0.3s cubic-bezier(.25, .8, .25, 1);
        }

        body {
            /* Compatible with everything, and anything. */
            font-family: sans-serif;
            /* Off white to reduce eye strain. */
            background-color: #DCDCDC;
            margin: auto;
            padding: 0% 3% 0% 3%;
            max-width: 1200px;
            /* Off black to reduce eye strain. */
            color: #2A2A2A;
        }

        h1,
        h1.a {
            letter-spacing: 0.03em;
            font-size: 4.5em;
            word-spacing: 5em;
            line-height: 1.1em;
            margin: 0%;
            font-weight: 100;
        }

        h3 {
            letter-spacing: 0.01rem;
            font-size: 2.4rem;
            font-weight: 100;
        }

        ul li {
            font-size: 1.4rem;
            line-height: 2rem;
        }

        p {
            font-size: 1.4rem;
            line-height: 2rem;
        }

        body>article>p>a {
            text-decoration: none;
            border-bottom: 1px solid #2A2A2A;
        }

        a:link,
        a:visited {
            color: #2A2A2A;
        }

        a:hover,
        a:active {
            color: grey;
        }

        .underline {
            text-decoration: none;
        }

        blockquote {
            background: #f5f5f5;
            border-radius: 2px;
            padding: 1rem;
            margin: 0% 0% 0% 0%;
        }

        .links {
            display: flex;
            flex-flow: column wrap;
            align-items: flex-end;
            justify-content: space-between;
        }

        h1>a:link,
        h1>a:visited {
            color: grey;
        }

        h1>a:hover,
        h1>a:active {
            color: #d2d2d2;
        }

        .top {
            display: flex;
            justify-content: space-between;
        }

        img {
            width: 100%;
        }

        @media (max-width: 680px) {
            .hidemobile {
                display: none;
            }
        }

        /*https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme*/
        @media (prefers-color-scheme: dark) {
            .center {
                /* Off white to reduce eye strain. */
                background: #242424;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            }

            body {
                /* Off black to reduce eye strain. */
                background-color: #171717;
                /* Off white to reduce eye strain. */
                color: #e3e3e3;
            }

            blockquote {
                background: #2e2e2e;
            }

            body>article>p>a {
                text-decoration: none;
                border-bottom: 1px solid #4db2ff;
            }

            a:link,
            a:visited {
                color: #e3e3e3;
            }

            a:hover,
            a:active {
                color: #0091ff;
            }

            h1>a:link,
            h1>a:visited {
                color: #6b6b6b;
            }

            h1>a:hover,
            h1>a:active {
                color: #0091ff;
            }
        }
    </style>
</head>

<body>
    <header class="center top">
        <a href="./../../index.html" class="underline">
            <h1>Thomas<br>August<br>Ryan</h1>
        </a>
        <h1 class="links hidemobile">
            <a href="./../../posts.html" class="underline">Posts</a>
            <a href="./../../demos.html" class="underline">Demos</a>
            <a href="./../../resume.pdf" class="underline">Résumé</a>
        </h1>
    </header>
    <article class="center">
        <time datetime="2020-05-22">
            <h2>January 12th, 2022</h2>
        </time>
        <h3>Using Next.js and ArcGIS JS to build Geospatial Web Apps</h3>
        <p><a href="https://developers.arcgis.com/javascript/latest/get-started/" target="_blank"
                rel="noopener noreferrer">ArcGIS JS</a> is a JavaScript library for creating web maps using ESRI’s
            ecosystem of tools and services. <a href="https://nextjs.org/" target="_blank"
                rel="noopener noreferrer">Next.js</a>
            is a framework for building web apps. To render elements on a web page, Next.js uses the <a
                href="https://reactjs.org/" target="_blank" rel="noopener noreferrer">React.js</a> library
            which guides you into a functional programming style with components and hooks. Unfortunately, ArcGIS JS
            uses a traditional object-oriented programming style which conflicts conceptually with the functional style
            of React. To get around this we can isolate our use of the ArcGIS JS library to a single React component
            we'll
            name EsriMap.
        </p>
        <a href="nextjsarcgisjswebapp.webp" title="A Next.js and ArcGIS JS web app"><img src="nextjsarcgisjswebapp.webp"
                alt="A Next.js and ArcGIS JS web app"></a>
        <p>One of the core features of the Next.js framework is static site generation, but we don’t want to use that
            for our map component because we’re going to be adding and removing layers dynamically. We can tell
            Next.js to only render this component on the client side by setting 'ssr: false' and importing the component
            dynamically in our index.js file. </p>
        <blockquote>
            <pre><code>
        const EsriMapWithNoSSR = dynamic(() => import("../components/esri-map"), 
        {
            ssr: false,
        });
        </code></pre>
        </blockquote>
        <p>Inside of the EsriMap component we must be extra careful to manage the items that we don’t want React to
            re-render when the state of the component is changed. Thankfully React provides the useRef() hook so we can
            isolate the div element with an id of 'mapDiv' that ArcGIS JS manipulates to render our web map. But we also
            need to isolate
            the WebMap object that we use to define and configure our map before it gets rendered into the mapDiv
            element on
            the page. </p>
        <blockquote>
            <pre><code>
                // This is the div that the ArcGIS JS library mutates. 
                // We don't want React to mess with it,
                // so it's encapsulated it in a UseRef().
        
                const mapDiv = useRef(null);
        
                // This is the webmap object itself. 
                // Once it has been created we don't want to recreate it,
                // rather we just want to mutate it. 
                // Hence it's encapsulated in a UseRef() hook
                // so that React won't mess with it.
        
                let webMap = useRef(new WebMap({
                  portalItem: {
                    id: "123f123f123f123f12f311",
                    portal: portal
                  }
                }));
                </code></pre>
        </blockquote>
        <p> WebMap object stores the state of our web map so you can think of it as a kind of God-object. If we did not
            isolate
            it using the useRef() hook, React would re-render it when the state of the component’s props changed. This
            bug presents to the user as the map flashing and then reloading every time they change the selected layer in
            the side panel of the web app.</p>
        <h3>Two hooks this time</h3>
        <blockquote>
            <pre><code>
        // Only create the map once on the initial load of the component.

        useEffect(() => {

            // Grab the webmap object out of the UseRef() hook
            // so that we can mutate it.

            let webmap = webMap.current;

            // Configure the map...

        }, [
            
            // This array is empty so this useEffect hook only runs once on load.

        ]);
        </code></pre>
        </blockquote>
        <p>Still there is a clear need for users to change what they are seeing on the map. To handle this we can take
            advantage of the useEffect() hook by using it twice. The first time we will create the web map and configure
            it. This will happen only once when the web page is initially rendered. </p>
        <blockquote>
            <pre><code>
        // When an update is made to a state varible,
        // we can update the map from here.
        // Without completely recreating it.

        useEffect(() => {

            // Grab the webmap object out of the UseRef() hook
            // so that we can mutate it.

            let webmap = webMap.current;
          
            // Mutate the map...

        }, [
            
        selectedAssetType, setSelectedAssetData

        // When these useState values are updated
        // it will force this component to re-render. 
            
        ]);
        </code></pre>
        </blockquote>
        <p>Our second useEffect() hook will be triggered by updates to a useState() hook that’s defined on the index.js
            page of our app. It’s updated by a drop down on the side panel and then passed up through the component tree
            and finally back down into our EsriMap component as a prop where it triggers this second useEffect() hook to
            run. We then use the current value of the hook to set the visible layer on the Web Map.</p>
        <h3>Two way data flow</h3>
        <p>Finally, we must handle passing data and events from our isolated map component back up into the tree of
            React components. When the user clicks on a thing, we want the side panel to display the attributes of that
            thing. We can do this by again defining a useState() hook in our index.js file, passing it’s set function
            down to EsriMap as a prop, and then updating it with the values of the thing that was selected inside the
            map’s view.on(“click”, () => { }) event handler. We define this event handler in the first useEffect() hook
            when we are creating and configuring the Web Map object. </p>
        <blockquote>
            <pre><code>
        view.on("click", function (event) {
                    
            view.hitTest(event).then(function (response) {
              for (let i in response.results) {
                       
                let attr = response.results[i].graphic.attributes;
          
                // This function updates the state of the hook
                // in the parent component.

                setSelectedAssetData(attr);  

              }
            })
          });
        </code></pre>
        </blockquote>
        <p>
            When the set function is called to update the value of the hook inside the click event on the map, React
            will update the state of the components in the tree that take this value as a prop. The side panel will now
            display the attributes of the thing the user selected on the map.
        </p>
        <p>
            We’ve now established how to prevent our map from re-rendering constantly and how to pass data into and out
            of our map using Reacts hooks. Hopefully you can put this knowledge to use to build something cool with
            ArcGIS JS and Next.js.
        </p>
    </article>
    <footer class="center top">
        <a href="./../../index.html" class="underline hidemobile">
            <h1>Thomas<br>August<br>Ryan</h1>
        </a>
        <h1 class="links">
            <a href="./../../posts.html" class="underline">Posts</a>
            <a href="./../../demos.html" class="underline">Demos</a>
            <a href="./../../resume.pdf" class="underline">Résumé</a>
        </h1>
    </footer>
</body>

</html>